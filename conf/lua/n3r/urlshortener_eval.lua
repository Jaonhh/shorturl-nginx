-- TwemProxy支持EVAL命令，但只是将script作为key进行哈希映射到后端redis server

-- "database scheme"
-- database 0: id ~> url
-- database 1: md5 ~> id (lookup if we have shorten the url already)
-- database 2: key "shorten.count" storing the number of shortened urls;
--             the id is generated by (this number + 1) converted to base 62
-- database 3: id ~> hits
-- database 4: id ~> [{referer|user_agent}]
-- database 5: id ~> misses
-- database 6: id ~> [{referer|user_agent}] (when id is not found)

local _M = {
    _VERSION = '0.2'
}
 
local connect = function()
    local redis = require "resty.redis"
    local red = redis:new()
    red:set_timeout(1000) -- 1 sec
    local ok, err = red:connect("127.0.0.1", 6379)
    if not ok then
        ngx.say(err)
        return ngx.exit(ngx.ERROR)
    end
 
    return red
end

local pack_script =  "local short_pre = ARGV[1] "
                  .. "local arg_url = ARGV[2] "
                  .. "local md5_url = ARGV[3] "
                  .. "local checkAlready = ARGV[4]"
                  .. "\n "
                  .. "local basen = function(n) "
                  .. "    local digits = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ' "
                  .. "    local t = {} "
                  .. "    repeat "
                  .. "        local d = (n % 62) + 1 "
                  .. "        n = math.floor(n / 62) "
                  .. "        table.insert(t, 1, digits:sub(d, d)) "
                  .. "    until n == 0 "
                  .. "    return table.concat(t, ''); "
                  .. "end "
                  .. "\n "
                  .. "if checkAlready or true then " 
                  .. "    redis.call('select', 1) "
                  .. "    local id, err = redis.call('get', md5_url) "
                  .. "    if id then "
                  .. "        return short_pre .. id "
                  .. "    end "
                  .. "end "
                  .. "\n "
                  .. "redis.call('select', 2) "
                  .. "local count, err = redis.call('incr', 'shorten.count') "
                  .. "local id, err = basen(count) "
                  .. "\n "
                  .. "if checkAlready or true then "
                  .. "    redis.call('select', 1) "
                  .. "    redis.call('set', md5_url, id) "
                  .. "end "
                  .. "\n "
                  .. "redis.call('select', 0) "
                  .. "redis.call('set', id, arg_url) "
                  .. "\n "
                  .. "return short_pre .. id "
 
function _M.pack(url, shortPrefix, checkAlready)
    if shortPrefix == nil then
        local port = ""
        if ngx.var.server_port ~= "80" then
            port = ":" .. ngx.var.server_port
        end

        shortPrefix = "http://" .. ngx.var.server_name .. port .. "/"
    else
        shortPrefix = "http://" .. shortPrefix .. "/"
    end

    local hash = ngx.md5(url)

    local red = connect()
    local res, err = red:eval(pack_script, 4, "short_pre", "arg_url", "md5_url", "checkAlready", 
        shortPrefix, url, hash, checkAlready);
    
    if not res then
        ngx.say(err)
        return ngx.exit(ngx.ERROR)
    end

    ngx.say(res)
    return ngx.exit(ngx.OK)
end

local unpack_script = "local id = ARGV[1] "
                   .. "local referer_agent = ARGV[2] "
                   .. "local recordHits = ARGV[3] "
                   .. "local recordReferAndUserAgent = ARGV[4] "
                   .. "\n "
                   .. "redis.call('select', 0) "
                   .. "local url, err = redis.call('get', id) "
                   .. "if not url then "
                   .. "    if recordHits then "
                   .. "        redis.call('select', 5) "
                   .. "        redis.call('incr', id) "
                   .. "    end "
                   .. "    if recordReferAndUserAgent then "
                   .. "        redis.call('select', 6) "
                   .. "        redis.call('rpush', id, referer_agent) "
                   .. "    end "
                   .. "    -- distinguish the error from misses \n "
                   .. "    return nil "
                   .. "end "
                   .. "\n "
                   .. "if recordHits then "
                   .. "    redis.call('select', 3) "
                   .. "    redis.call('incr', id) "
                   .. "end "
                   .. "if recordReferAndUserAgent then "
                   .. "    redis.call('select', 4) "
                   .. "    redis.call('rpush', id, referer_agent) "
                   .. "end "
                   .. "return url "
 
function _M.unpack(notFoundRedirect, recordHits, recordReferAndUserAgent)
    local id = string.sub(ngx.var.request_uri, 2) -- remove prefix /
    
    -- what's the fuck!
    -- if puts the operation (referer .. '|' .. user_agent) in the unpack script,
    -- then occur various errors
    local referer = ngx.var.http_referer or ""
    local user_agent = ngx.var.http_user_agent or ""

    local red = connect()
    local res, err = red:eval(unpack_script, 4, "id", "referer_agent", "recordHits", "recordReferAndUserAgent", 
        id, referer .. "|" .. user_agent, recordHits, recordReferAndUserAgent);

    if res == ngx.null then
        if notFoundRedirect then
            return ngx.redirect(notFoundRedirect)
        end
        ngx.exit(ngx.HTTP_NOT_FOUND)
    end

    return ngx.redirect(res)
end
 
return _M
